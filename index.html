<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MediaPipe Pose Landmarker Task for web</title>
    <link rel="stylesheet" href="./style.css" />
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

    <style>
      /* Layout básico */
      body { margin: 0; background: #000; }
      #liveView {
        width: 100%;
        max-width: 1280px;
        margin: 0 auto;
        padding: 12px;
        box-sizing: border-box;
      }
      .controls { display: flex; gap: 8px; margin-bottom: 12px; }

      /* Stage: vídeo + canvas sobrepostos */
      .stage {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        background: #000;
        overflow: hidden;
      }
      .stage > video,
      .stage > canvas {
        position: absolute; inset: 0;
        width: 100%; height: 100%;
        object-fit: cover;
      }

      /* 🔁 Espelho: aplica em vídeo e canvas (inclusive em fullscreen) */
      #liveView.mirrored .stage > video,
      #liveView.mirrored .stage > canvas {
        transform: scaleX(-1);
      }

      /* Fullscreen nativo (mantém transform!) */
      #liveView:fullscreen,
      #liveView:-webkit-full-screen {
        width: 100vw; height: 100vh; background: #000;
        margin: 0; padding: 0;
      }
      #liveView:fullscreen .stage,
      #liveView:-webkit-full-screen .stage {
        width: 100vw; height: 100vh; aspect-ratio: auto;
      }
      #liveView:fullscreen video,
      #liveView:fullscreen canvas,
      #liveView:-webkit-full-screen video,
      #liveView:-webkit-full-screen canvas {
        width: 100vw !important; height: 100vh !important; object-fit: cover;
        /* 👇 não resetar transform aqui */
      }

      /* Soft fullscreen (iOS fallback) — também mantém transform */
      #liveView.soft-fs {
        position: fixed !important; inset: 0 !important;
        width: 100vw !important; height: 100vh !important;
        background: #000 !important; z-index: 9999 !important; margin: 0 !important; padding: 0 !important;
      }
      #liveView.soft-fs .stage {
        width: 100vw !important; height: 100vh !important; aspect-ratio: auto;
      }
      #liveView.soft-fs video,
      #liveView.soft-fs canvas {
        width: 100vw !important; height: 100vh !important; object-fit: cover;
        /* 👇 não resetar transform aqui */
      }
    </style>
  </head>

  <body>
    <!-- Copyright 2023 The MediaPipe Authors. Apache 2.0 -->

    <!-- Adicione 'mirrored' aqui para espelhar sempre -->
    <div id="liveView" class="videoView mirrored">
      <div class="controls">
        <button id="webcamButton" class="mdc-button mdc-button--raised">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">ENABLE WEBCAM</span>
        </button>

        <button id="fsButton" class="mdc-button mdc-button--outlined" aria-pressed="false" title="Fullscreen">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">Fullscreen</span>
        </button>
      </div>

      <div class="stage">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas class="output_canvas" id="output_canvas" width="1280" height="720"></canvas>
      </div>
    </div>

    <!-- Seu script de MediaPipe -->
    <script type="module" src="./script.js"></script>

    <!-- Botão Fullscreen + correções -->
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const liveView = document.getElementById('liveView');
        const fsBtn = document.getElementById('fsButton');
        const videoEl = document.getElementById('webcam');

        // Garantias para iOS
        videoEl.setAttribute('playsinline', '');
        videoEl.setAttribute('muted', '');

        const isNativeFS = () =>
          document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;

        const canElemFS = !!(liveView.requestFullscreen || liveView.webkitRequestFullscreen || liveView.msRequestFullscreen);

        async function enterFS(el) {
          if (el.requestFullscreen) return el.requestFullscreen();
          if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
          if (el.msRequestFullscreen) return el.msRequestFullscreen();
        }
        async function exitFS() {
          if (document.exitFullscreen) return document.exitFullscreen();
          if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
          if (document.msExitFullscreen) return document.msExitFullscreen();
        }

        function setSoftFS(on) {
          liveView.classList.toggle('soft-fs', on);
          updateBtn(on || !!isNativeFS());
        }

        function updateBtn(full) {
          const label = fsBtn.querySelector('.mdc-button__label');
          if (full) {
            fsBtn.classList.add('mdc-button--raised');
            fsBtn.classList.remove('mdc-button--outlined');
            fsBtn.setAttribute('aria-pressed', 'true');
            label.textContent = 'Exit Fullscreen';
          } else {
            fsBtn.classList.remove('mdc-button--raised');
            fsBtn.classList.add('mdc-button--outlined');
            fsBtn.setAttribute('aria-pressed', 'false');
            label.textContent = 'Fullscreen';
          }
        }

        // Mantém UI sincronizada; NÃO removemos 'mirrored'
        ['fullscreenchange', 'webkitfullscreenchange', 'MSFullscreenChange'].forEach(evt => {
          document.addEventListener(evt, () => updateBtn(!!isNativeFS()));
        });

        fsBtn.addEventListener('click', async () => {
          try {
            const nfs = !!isNativeFS();
            const softOn = liveView.classList.contains('soft-fs');

            if (nfs || softOn) {
              if (nfs) await exitFS();
              if (softOn) setSoftFS(false);
              updateBtn(false);
              return;
            }

            // Entrar
            if (canElemFS && (document.fullscreenEnabled || document.webkitFullscreenEnabled)) {
              await enterFS(liveView);
              updateBtn(true);
            } else {
              // Fallback iOS sem usar webkitEnterFullscreen() no <video>
              setSoftFS(true);
            }
          } catch (e) {
            console.error(e);
            setSoftFS(true);
          }
        });
      });
    </script>
  </body>
</html>
